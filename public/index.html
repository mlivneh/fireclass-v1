<!DOCTYPE html>
<!--
 * Copyright Â© 2025 Meir Livneh. All Rights Reserved.
 *
 * This software and associated documentation files (the "Software") are proprietary and confidential.
 * The Software is furnished under a license agreement and may be used or copied only in
 * accordance with the terms of the agreement.
 *
 * Unauthorized copying of this file, via any medium, is strictly prohibited.
-->
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - ClassroomSDK</title>
    <!-- CSS Link -->
    <link rel="stylesheet" href="css/teacher-dashboard.css">
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>
    <!-- ==================== NEW LOGIN SCREEN START ==================== -->
<div id="login-container" class="login-overlay" style="display: none;">
    <div class="login-box">
        <div class="logo">
            <span class="logo-icon">âš™ï¸</span>
            <span class="logo-text">fireClass Control</span>
        </div>
        <p>Welcome, please sign in to continue.</p>

        <div class="signin-options-title">Signin Options</div>

        <div class="signin-options">
            <button id="google-signin-btn" class="signin-btn" title="Sign in with Google">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google Logo">
            </button>
            <button id="microsoft-signin-btn" class="signin-btn" title="Sign in with Microsoft">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/Microsoft_logo.svg" alt="Microsoft Logo">
            </button>
        </div>
    </div>
</div>
<!-- ===================== NEW LOGIN SCREEN END ===================== -->

    <!-- ==================== NEW HEADER START ==================== -->
<header class="header">
    <div class="nav-container">
        <!-- Left Side: Logo and Room Code -->
        <div class="header-left">
            <div class="logo">
                <span class="logo-icon">âš™ï¸</span>
                <span class="logo-text">fireClass Control</span>
            </div>
            <div id="header-room-display" class="header-room-display">
                <span class="room-code-label">Room:</span>
                <span id="header-room-code" class="room-code-value">...</span>
                <img id="qr-code-image" class="qr-code" alt="QR Code" title="Click to copy student link"/>
            </div>
        </div>

        <!-- Center: Navigation Menu -->
        <nav class="header-center">
            <ul class="nav-menu">
                <!-- Quick Actions -->
                <li class="nav-item">
                    <a href="#" class="nav-link"><span class="nav-icon">âš¡</span><span>Quick Actions</span></a>
                    <div class="dropdown">
                        <div class="dropdown-header">Quick actions for lesson management</div>
                        <a href="#" class="dropdown-item success-item" onclick="sendQuickMessage('Let\'s start the lesson!')"><span class="dropdown-icon">ğŸ“</span><div class="dropdown-content"><div class="dropdown-title">Start Lesson</div><div class="dropdown-desc">Send message to all students</div></div></a>
                        <a href="#" class="dropdown-item warning-item" onclick="sendQuickMessage('Time for a break! Come back in 5 minutes.')"><span class="dropdown-icon">â˜•</span><div class="dropdown-content"><div class="dropdown-title">Break Time</div><div class="dropdown-desc">Announce break time</div></div></a>
                        <a href="#" class="dropdown-item" onclick="sendQuickMessage('The lesson has ended. Well done everyone!')"><span class="dropdown-icon">âœ…</span><div class="dropdown-content"><div class="dropdown-title">End Lesson</div><div class="dropdown-desc">Finish the lesson</div></div></a>
                        <a href="#" class="dropdown-item danger-item" onclick="resetClassroomData()"><span class="dropdown-icon">ğŸ”„</span><div class="dropdown-content"><div class="dropdown-title">New Lesson</div><div class="dropdown-desc">Clear all lesson data</div></div></a>
                    </div>
                </li>
                <!-- Games and Content -->
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="window.teacherDashboard.openContentModal()"><span class="nav-icon">ğŸ®</span><span>Games & Content</span></a>
                </li>
                <!-- AI Management -->
                <li class="nav-item">
                    <a href="#" class="nav-link" id="aiMenuLink"><span class="nav-icon">ğŸ¤–</span><span>AI Management</span></a>
                    <div class="dropdown">
                        <div class="dropdown-header">AI Assistant settings for students</div>
                        <a href="#" class="dropdown-item" id="toggleAI" onclick="console.log('ğŸŸ¢ TRACE: AI button clicked'); window.teacherDashboard.toggleAIForClass()"><span class="dropdown-icon" id="aiStatusIcon">ğŸ”´</span><div class="dropdown-content"><div class="dropdown-title" id="aiStatusText">AI disabled for students</div><div class="dropdown-desc">Click to enable</div></div></a>
                        <div style="padding: 10px 20px; border-top: 1px solid #f0f2f5; background: #f8f9fa;"><strong style="font-size: 14px; color: #555;">ğŸ¯ Select model for class:</strong><div style="font-size: 12px; color: #777; margin-top: 2px;">Current model: <span class="current-ai-model">ChatGPT</span></div></div>
                        <a href="#" class="dropdown-item ai-model-btn" data-model="chatgpt" onclick="window.teacherDashboard.switchAIModel('chatgpt')"><span class="dropdown-icon">ğŸ¤–</span><div class="dropdown-content"><div class="dropdown-title">ChatGPT</div><div class="dropdown-desc">Advanced model from OpenAI</div></div></a>
                        <a href="#" class="dropdown-item ai-model-btn" data-model="claude" onclick="window.teacherDashboard.switchAIModel('claude')"><span class="dropdown-icon">ğŸ§ </span><div class="dropdown-content"><div class="dropdown-title">Claude</div><div class="dropdown-desc">Smart model from Anthropic</div></div></a>
                        <a href="#" class="dropdown-item ai-model-btn" data-model="gemini" onclick="window.teacherDashboard.switchAIModel('gemini')"><span class="dropdown-icon">âœ¨</span><div class="dropdown-content"><div class="dropdown-title">Gemini</div><div class="dropdown-desc">Google's model</div></div></a>
                    </div>
                </li>
                <!-- Tools -->
                <li class="nav-item">
                    <a href="#" class="nav-link"><span class="nav-icon">ğŸ”§</span><span>Tools</span></a>
                    <div class="dropdown">
                        <div class="dropdown-header">Utilities and debugging tools</div>
                        <a href="#" class="dropdown-item" onclick="toggleDebug()"><span class="dropdown-icon">ğŸ›</span><div class="dropdown-content"><div class="dropdown-title">Debug Console</div><div class="dropdown-desc">Show technical information</div></div></a>
                        <a href="#" class="dropdown-item" onclick="exportData()"><span class="dropdown-icon">ğŸ“Š</span><div class="dropdown-content"><div class="dropdown-title">Export Data</div><div class="dropdown-desc">Save student list and messages</div></div></a>
                        <a href="#" class="dropdown-item" id="open-content-manager-btn">
                            <span class="dropdown-icon">ğŸ“š</span>
                            <div class="dropdown-content">
                                <div class="dropdown-title">Manage Content & AI</div>
                                <div class="dropdown-desc">Edit your personal links and AI prompts</div>
                            </div>
                        </a>
                    </div>
                </li>
                <!-- Polls -->
                <li class="nav-item">
                    <a href="#" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>Polls</span></a>
                    <div class="dropdown">
                        <a href="#" class="dropdown-item" onclick="window.teacherDashboard.openPollCreationModal()"><span class="dropdown-icon">â•</span><div class="dropdown-content"><div class="dropdown-title">Start New Poll</div><div class="dropdown-desc">Send quick question to class</div></div></a>
                    </div>
                </li>
                <!-- Reports -->
                <li class="nav-item">
                    <a href="#" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>Reports</span></a>
                    <div class="dropdown">
                        <div class="dropdown-header">Reports and analytics (FFU)</div>
                        <a href="#" class="dropdown-item" onclick="generateLessonSummary()"><span class="dropdown-icon">ğŸ“‹</span><div class="dropdown-content"><div class="dropdown-title">Lesson Summary</div><div class="dropdown-desc">Comprehensive AI report of entire lesson</div></div></a>
                        <a href="#" class="dropdown-item" onclick="exportLessonData()"><span class="dropdown-icon">ğŸ’¾</span><div class="dropdown-content"><div class="dropdown-title">Export Lesson Data</div><div class="dropdown-desc">Save all data to file</div></div></a>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- Right Side: Actions & Status -->
        <div class="header-right">
            <!-- New End Lesson Button with Dropdown -->
            <div class="dropdown-action-btn" id="end-lesson-controls">
                <button class="main-action-icon">âœ–</button>
                <div class="dropdown">
                    <a href="#" class="dropdown-item" id="reset-screens-action">
                        <span class="dropdown-icon">â¹ï¸</span>
                        <div class="dropdown-content">
                            <div class="dropdown-title">Clear Screens</div>
                            <div class="dropdown-desc">Reset all student screens</div>
                        </div>
                    </a>
                    <a href="#" class="dropdown-item danger-item" id="end-lesson-action" onclick="document.getElementById('end-lesson-modal').classList.add('visible')">
                        <span class="dropdown-icon">ğŸš«</span>
                        <div class="dropdown-content">
                            <div class="dropdown-title">Exit Lesson</div>
                            <div class="dropdown-desc">End lesson and show report options</div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- New Logout Button -->
            <button id="logout-action-btn" class="main-action-icon green" title="Logout">ğŸšª</button>

            <!-- New Connection Status Indicator -->
            <div id="connectionStatus" title="Connecting..."></div>
        </div>
    </div>
</header>
<!-- ===================== NEW HEADER END ===================== -->

    <!-- Main Content -->
    <div class="main-content" style="display: none;">
        <!-- Students Section -->
        <div class="section">
            <h2>ğŸ‘¥ Connected Students (<span id="studentsCount">0</span>)</h2>
            <div id="studentsList" class="students-list">
                <div class="no-students">No students connected yet</div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="section">
            <h2>ğŸ’¬ Communication with Students</h2>
            <div id="messagesArea" class="chat-messages">
                <div class="no-messages">No messages yet</div>
            </div>
            <form id="chat-form" style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Type a message to all students..." required style="flex-grow: 1;">
                <button type="submit">Send</button>
            </form>
        </div>

        <!-- Poll Section -->
        <div class="section" id="poll-section" style="display:none;">
            <h2>ğŸ“Š Real-time Poll Results</h2>
            <div id="poll-results-container"></div>
            <button id="stop-poll-btn" style="background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px;">End poll and hide results</button>
        </div>

        <!-- Activity Section -->
        <div class="section">
            <h2>ğŸ“Š Recent Activity</h2>
            <div id="activitiesArea" class="activity-log">
                <div class="no-activity">No activity yet</div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="studentTemplate">
        <div class="student-item">
            <div class="student-info">
                <span class="student-name"></span>
                <div class="student-actions"></div>
            </div>
        </div>
    </template>

    <!-- Private Message Modal -->
    <div id="privateMessageModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœ‰ï¸ Private Message</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <p>Sending private message to: <span id="privateMessageRecipient"></span></p>
                <textarea id="privateMessageText" placeholder="Write your private message..." rows="4"></textarea>
            </div>
            <div class="modal-footer">
                <button class="modal-close">Cancel</button>
                <button onclick="sendPrivateMessage()" class="primary">Send Message</button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’¬ Send Message to Class</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <textarea id="messageText" placeholder="Write a message to all students..." rows="4" required></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-close">Cancel</button>
                <button type="submit" form="messageForm" class="primary">Send Message</button>
            </div>
        </div>
    </div>

    <!-- Custom Content Modal -->
    <div id="customContentModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ğŸ“¤ Send Game or Content to Students</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="game-list-container" style="padding: 20px; max-height: 300px; overflow-y: auto; border-bottom: 1px solid #eee;">
                </div>
                <div id="custom-url-section" style="padding: 20px; background: #f9f9f9;">
                    <p style="margin: 0 0 10px 0; font-weight: 500;">Or send custom link:</p>
                    <form id="customUrlForm" style="display: flex; gap: 10px;">
                        <input type="url" id="customUrlInput" placeholder="Enter full URL..." required style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                        <button type="submit" class="primary" style="white-space: nowrap;">Send Link</button>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                 <a href="#" class="danger-item" onclick="window.teacherDashboard.sendCommand('LOAD_CONTENT', { url: 'about:blank' })" style="margin-right: auto; text-decoration:none; padding: 8px 12px; border-radius: 6px;">
                    â¹ï¸ Stop content and clear screens
                </a>
                <button class="modal-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Poll Creation Modal -->
    <div id="poll-creation-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Select Poll Type</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <button class="poll-type-btn" data-type="yes_no">Yes / No Poll</button>
                <button class="poll-type-btn" data-type="multiple_choice">Multiple Choice Poll (1-4)</button>
                <button class="poll-type-btn" data-type="open_text">Open Question (Free text)</button>
            </div>
        </div>
    </div>

    <!-- Open Question Modal -->
    <div id="open-question-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Open Question Responses</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div id="open-question-results" class="modal-body" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button id="ai-summarize-btn">Summarize with AI</button>
                    <button id="ai-keywords-btn">Extract Keywords</button>
                </div>
                <button id="close-open-question-btn" class="danger-item" style="padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">
                    â¹ï¸ End Poll
                </button>
            </div>
        </div>
    </div>

    <!-- End Lesson Modal -->
    <div id="end-lesson-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ End of Lesson</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <p>The lesson has ended! Choose which report you'd like to generate:</p>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button class="poll-type-btn" onclick="generateLessonSummary()">
                        ğŸ“‹ Comprehensive Summary Report
                    </button>
                    <button class="poll-type-btn" onclick="exportLessonData()">
                        ğŸ’¾ Export Lesson Data
                    </button>
                    <button class="poll-type-btn" onclick="generateStudentProgress()">
                        ğŸ‘¥ Student Progress Report
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close">Close</button>
            </div>
        </div>
    </div>

<!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-functions-compat.js"></script>
    <script src="firebase-config.js"></script>

    <!-- ×˜×¢×Ÿ ××ª ClassroomSDK ×œ×¤× ×™ teacher-dashboard -->
    <script src="js/ClassroomSDK.js"></script>
    <script src="js/teacher-dashboard.js"></script>

    <!-- =========================================================== -->
    <!-- ========= CONTENT & AI PROMPT MANAGEMENT MODAL V2 ========= -->
    <!-- =========================================================== -->
    <div id="content-manager-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px; height: 80vh;">
            <div class="modal-header">
                <h3>ğŸ“š Manage Your Content & AI Contexts</h3>
                <button class="modal-close">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; height: calc(100% - 70px);">
                <!-- Tabs Navigation -->
                <div class="tabs">
                    <button class="tab-link active" data-tab="tab-my-content">My Content</button>
                    <button class="tab-link" data-tab="tab-my-prompts">My AI Prompts</button>
                </div>

                <!-- Tab 1: My Content (Links) -->
                <div id="tab-my-content" class="tab-content active two-column-grid">
                    <div class="column-left scrollable">
                        <h4>My Content Library</h4>
                        <div class="content-list" id="personal-content-list">
                            <!-- Personal links will be dynamically inserted here -->
                        </div>
                    </div>
                    <div class="column-right">
                        <h4>Add / Edit Content</h4>
                        <form id="personal-content-form">
                            <input type="text" id="content-title" placeholder="Title (e.g., 'PhET Simulation')" required>
                            <input type="text" id="content-desc" placeholder="Description" required>
                            <input type="text" id="content-icon" placeholder="Icon (e.g., 'ğŸ¯')" required>
                            <input type="url" id="content-url" placeholder="https://..." required>
                            <input type="hidden" id="content-id">
                            <button type="submit">Save Content</button>
                            <button type="button" id="cancel-content-edit" class="secondary" style="display:none;">Cancel Edit</button>
                        </form>
                    </div>
                </div>

                <!-- Tab 2: My AI Prompts -->
                <div id="tab-my-prompts" class="tab-content two-column-grid">
                    <div class="column-left scrollable">
                        <h4>My Prompt Library</h4>
                        <div class="active-prompt-selector-container">
                            <label for="active-prompt-selector">Active AI Context for Class:</label>
                            <select id="active-prompt-selector">
                                <option value="general">General (Open Context)</option>
                            </select>
                        </div>
                        <div class="content-list" id="personal-prompts-list">
                            <!-- Personal prompts will be dynamically inserted here -->
                        </div>
                    </div>
                    <div class="column-right">
                        <h4>Prompt Creation Wizard</h4>
                        <div class="prompt-wizard">
                            <form id="personal-prompt-form">
                                <p>1. Select a main subject:</p>
                                <select id="prompt-subject-selector" required>
                                    <option value="" disabled selected>Choose a subject...</option>
                                    <option value="General">General</option>
                                    <option value="Math">Math</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Biology">Biology</option>
                                    <option value="History">History</option>
                                    <option value="Literature">Literature</option>
                                    <option value="Computer Science">Computer Science</option>
                                </select>

                                <p>2. Add specific keywords (optional):</p>
                                <input type="text" id="prompt-keywords-input" placeholder="e.g., Pythagorean theorem, triangles">

                                <button type="button" id="generate-prompt-suggestion-btn">Create a Prompt for Me</button>

                                <hr>

                                <p>3. Refine the suggested prompt and save it:</p>
                                <input type="text" id="prompt-title" placeholder="Prompt Title (e.g., 'Pythagorean Theorem')" required>
                                <textarea id="prompt-content" rows="5" required></textarea>
                                <input type="hidden" id="prompt-id">
                                <button type="submit">Save Prompt</button>
                                <button type="button" id="cancel-prompt-edit" class="secondary" style="display:none;">Cancel Edit</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        console.log('ğŸŸ¢ TRACE: index.html loaded');
        
        // ×•×•×“× ×©Firebase ×××•×ª×—×œ
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const functions = firebase.functions();
        
        console.log('ğŸ” Firebase initialized');
        console.log('ğŸ” ClassroomSDK available:', typeof ClassroomSDK);
        
        window.teacherDashboard = new TeacherDashboard();
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                console.log('âœ… User is signed in:', user.uid);
                document.getElementById('loading-overlay').classList.remove('hidden'); // Show loading
                window.teacherDashboard.handleSuccessfulLogin(user)
                    .catch(err => {
                        console.error("Login handling failed", err);
                        window.teacherDashboard.logout(); // Logout on error
                    });
            } else {
                // User is signed out.
                console.log('ğŸšª User is signed out.');
                window.teacherDashboard.showLoginScreen();
            }
        });
        
        // ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª
        function sendQuickMessage(message) {
            console.log('ğŸŸ¢ TRACE: sendQuickMessage called');
            if (window.teacherDashboard) {
                window.teacherDashboard.sendMessageToClass(message);
            } else {
                console.error('âŒ teacherDashboard not available');
            }
        }

        function testAIService() {
            console.log('ğŸŸ¢ TRACE: testAIService called');
            if (window.teacherDashboard && window.teacherDashboard.testAIService) {
                window.teacherDashboard.testAIService();
            } else {
                console.error('âŒ testAIService not available');
            }
        }

        function sendPrivateMessage() {
            if (window.teacherDashboard && window.teacherDashboard.sendPrivateMessage) {
                window.teacherDashboard.sendPrivateMessage();
            }
        }

        // ×‘×“×™×§×ª debug ×œ××¦×‘ ×”××¢×¨×›×ª
        function debugSystemState() {
            console.log('ğŸ” System Debug:');
            console.log('- window.teacherDashboard:', !!window.teacherDashboard);
            console.log('- teacherDashboard.sdk:', !!window.teacherDashboard?.sdk);
            console.log('- sdk.toggleAI:', !!window.teacherDashboard?.sdk?.toggleAI);
            console.log('- ClassroomSDK:', typeof ClassroomSDK);
            
            if (window.teacherDashboard?.sdk) {
                console.log('- SDK methods:', Object.getOwnPropertyNames(window.teacherDashboard.sdk));
            }
        }
        
        // ×§×¨× ×œ×‘×“×™×§×” ××—×¨×™ 3 ×©× ×™×•×ª
        setTimeout(debugSystemState, 3000);
    </script>
</body>
</html>