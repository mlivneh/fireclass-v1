const App={classroom:null,currentPollId:null,getOrCreateStudentId:function(){let e=sessionStorage.getItem("studentId");return e||(e="student_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),sessionStorage.setItem("studentId",e)),e},init:function(){this.loadRoomCodeFromURL(),document.getElementById("login-form")?.addEventListener("submit",this.handleLogin.bind(this))},loadRoomCodeFromURL:function(){const e=new URLSearchParams(window.location.search).get("classroom");if(e){const t=document.getElementById("teacher-uid");t&&(t.value=e)}},handleLogin:async function(e){e.preventDefault();const t=document.getElementById("player-name").value.trim(),n=document.getElementById("teacher-uid").value.trim(),o=e.target.querySelector("button");if(t&&/^\d{4}$/.test(n)){o.textContent="Joining...",o.disabled=!0;try{this.classroom=new ClassroomSDK;const e=this.getOrCreateStudentId();await this.classroom.init("student-app",e,t,n),document.getElementById("login-container").style.display="none",document.getElementById("main-container").style.display="block",this.classroom.createChatInterface(),this.classroom.createAIInterface(),this.classroom.createPollInterface(),this.classroom.listenForRoomUpdates(this.stateManager.bind(this)),this.classroom.listenForMessages(e=>{const t=document.getElementById("classroom-chat-container"),n=!t||"none"===t.style.display;e.forEach(e=>{this.classroom.addChatMessage(e.sender,e.content,e),n&&e.is_teacher&&this.classroom.toggleChat()})})}catch(e){console.error("❌ Failed to initialize student app:",e),alert(`Failed to join the room: ${e.message}\nPlease check the room code and try again.`),o.textContent="Join Lesson",o.disabled=!1}}else alert("Name and a 4-digit room code are required!")},stateManager:function(e){if(!e||!e.settings)return;const t=e.settings,n=t.currentPoll,o=t.current_command;this.classroom.isAiActiveForClass=!0===t.ai_active;const s=document.getElementById("classroom-poll-container"),r=document.getElementById("poll-badge"),a=n&&n.isActive;if(r&&s&&(s.dataset.active=a?"true":"false",r.style.display=a?"block":"none"),a?this.currentPollId!==n.id&&(this.currentPollId=n.id,this.renderPollInterface(n)):null!==this.currentPollId&&(this.clearPollInterface(),this.currentPollId=null),o&&"LOAD_CONTENT"===o.command){const e=document.getElementById("content-frame"),t=o.payload.url||"about:blank";e&&e.src!==t&&(e.src=t)}},renderPollInterface:function(e){const t=document.getElementById("classroom-poll-container"),n=document.getElementById("classroom-poll-content-area");if(t&&n)if(t.style.display="block","open_text"===e.type)n.innerHTML='\n                <p style="margin-top:0; margin-bottom:15px; font-weight:500;">The teacher is asking a question. Please type your answer below.</p>\n                <textarea id="open-answer-input" placeholder="Write your answer here..." style="width: 100%; height: 80px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;"></textarea>\n                <button id="submit-open-answer" style="width: 100%; padding: 12px; margin-top: 10px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer;">Submit Answer</button>\n            ',document.getElementById("submit-open-answer").onclick=e=>{const t=document.getElementById("open-answer-input"),n=t.value.trim(),o=e.currentTarget;n&&(this.classroom.submitPollAnswer(n),t.value="",o.textContent="✅ Answer Sent!",o.disabled=!0,setTimeout(()=>{o.textContent="Submit Answer",o.disabled=!1},2e3))};else{const t="yes_no"===e.type?["Yes","No"]:["1","2","3","4"];n.innerHTML='<p style="margin-top:0; margin-bottom:15px; font-weight:500;">The teacher is asking a quick question:</p>';const o=document.createElement("div");o.style.cssText="display: flex; gap: 10px; flex-wrap: wrap;";for(let s=1;s<=e.options;s++){const e=document.createElement("button");e.textContent=t[s-1],e.style.cssText="flex-grow: 1; padding: 12px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 6px; cursor: pointer;",e.onclick=()=>{this.classroom.submitPollAnswer(s),n.innerHTML='<p style="text-align:center; font-weight: bold; color: #28a745;">Thank you for your answer!</p>'},o.appendChild(e)}n.appendChild(o)}},clearPollInterface:function(){const e=document.getElementById("classroom-poll-container"),t=document.getElementById("classroom-poll-content-area");e&&(e.style.display="none",e.dataset.active="false"),t&&(t.innerHTML="")}};document.addEventListener("DOMContentLoaded",()=>{App.init()});